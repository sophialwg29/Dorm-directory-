<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dorm Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-600 to-purple-700 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center text-white mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">üè† Dorm Directory</h1>
            <p class="text-lg opacity-90">Find information about all residence halls</p>
        </header>

        <!-- Error Message -->
        <div id="error" class="bg-red-500 text-white p-4 rounded-lg mb-6 hidden"></div>

        <!-- Filters Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="sexFilter">Sex</label>
                    <select id="sexFilter" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Coed">Coed</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="quadFilter">Quad</label>
                    <select id="quadFilter" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                        <option value="">All</option>
                        <option value="South Quad">South Quad</option>
                        <option value="North Quad">North Quad</option>
                        <option value="West Quad">West Quad</option>
                        <option value="East Quad">East Quad</option>
                        <option value="Far Quad">Far Quad</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="capacityMin">Min Capacity</label>
                    <input type="number" id="capacityMin" placeholder="e.g., 100" min="0" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="capacityMax">Max Capacity</label>
                    <input type="number" id="capacityMax" placeholder="e.g., 300" min="0" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-600">
                </div>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="applyFilters()" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Filter</button>
                <button onclick="clearFilters()" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">Clear</button>
            </div>
        </div>

        <!-- Results Count -->
        <div class="text-white text-right mb-4 text-lg">
            <span id="resultCount">Loading...</span>
        </div>

        <!-- Grid and Loading State -->
        <div id="loading" class="text-white text-center py-16 text-xl">Loading dorm data...</div>
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
        <div id="emptyMessage" class="text-white text-center py-16 text-xl hidden">No dorms found matching your filters.</div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION - Update this API URL with your Google Apps Script deployment URL
        // ========================================
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbz0PX1QKTamC-s7Hz7x5fBpioSgVmZjJSgjVCtXt9yy1Goqff1ZUhUEd60qXVltdP3Feg/exec';
        
        let allDorms = [];
        let filteredDorms = [];

        // Function to create a dorm card
        function createDormCard(dorm) {
            const sexClass = dorm.Sex === 'Male' ? 'bg-blue-100 text-blue-700' : dorm.Sex === 'Female' ? 'bg-pink-100 text-pink-700' : 'bg-purple-100 text-purple-700';
            
            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden">
                    <div class="p-6">
                        <span class="${sexClass} inline-block px-3 py-1 rounded-full font-semibold text-sm mb-3">
                            ${dorm.Sex || 'Coed'}
                        </span>
                        <h3 class="text-xl font-bold text-indigo-600 mb-3">${dorm.Name}</h3>
                        
                        <div class="space-y-2 text-sm text-gray-700">
                            <div class="flex justify-between">
                                <span class="font-semibold">Quad:</span>
                                <span>${dorm.Quad}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Capacity:</span>
                                <span>${dorm.Capacity}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Colors:</span>
                                <span>${dorm.Colors}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Mascot:</span>
                                <span>${dorm.Mascot}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Chapel:</span>
                                <span>${dorm.Chapel}</span>
                            </div>
                            ${dorm.Notes ? `
                            <div class="pt-2 border-t">
                                <span class="font-semibold">Notes:</span>
                                <p class="text-gray-600 mt-1">${dorm.Notes}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <span class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold">
                                ${dorm.Quad}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fetch data from API
        async function fetchDormData() {
            try {
                console.log('Fetching from API:', API_BASE_URL);
                
                const apiUrl = API_BASE_URL + '?sheet=dorms';
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);
                
                // The API returns {dorms: [...]} or just [{...}, {...}]
                allDorms = data.dorms || data || [];
                
                if (!Array.isArray(allDorms)) {
                    allDorms = [];
                }
                
                if (allDorms.length === 0) {
                    showError('No dorm data found. Check that your Google Sheet has data in the "dorms" sheet with headers in row 1.');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                console.log('Successfully loaded', allDorms.length, 'dorms');
                filteredDorms = [...allDorms];
                renderGrid();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('Error fetching dorm data:', error);
                showError(`Failed to load dorm data: ${error.message}. Make sure your Google Apps Script is deployed and the URL is correct.`);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function applyFilters() {
            const sex = document.getElementById('sexFilter').value;
            const quad = document.getElementById('quadFilter').value;
            const capacityMin = parseInt(document.getElementById('capacityMin').value) || 0;
            const capacityMax = parseInt(document.getElementById('capacityMax').value) || Infinity;

            filteredDorms = allDorms.filter(dorm => {
                let capacity = dorm.Capacity;
                if (typeof capacity === 'string') {
                    capacity = parseInt(capacity);
                }
                if (isNaN(capacity)) capacity = 0;

                const sexMatch = !sex || dorm.Sex === sex;
                const quadMatch = !quad || dorm.Quad === quad;
                const capacityMatch = capacity >= capacityMin && capacity <= capacityMax;

                return sexMatch && quadMatch && capacityMatch;
            });

            renderGrid();
        }

        function clearFilters() {
            document.getElementById('sexFilter').value = '';
            document.getElementById('quadFilter').value = '';
            document.getElementById('capacityMin').value = '';
            document.getElementById('capacityMax').value = '';
            filteredDorms = [...allDorms];
            renderGrid();
        }

        function renderGrid() {
            const gridDiv = document.getElementById('grid');
            const emptyMessage = document.getElementById('emptyMessage');
            const resultCount = document.getElementById('resultCount');

            if (filteredDorms.length === 0) {
                gridDiv.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                resultCount.textContent = 'No results';
                return;
            }

            emptyMessage.classList.add('hidden');
            resultCount.textContent = `Showing ${filteredDorms.length} dorm${filteredDorms.length !== 1 ? 's' : ''}`;

            gridDiv.innerHTML = filteredDorms.map(dorm => createDormCard(dorm)).join('');
        }

        // Initialize
        console.log('Page loaded, fetching dorm data...');
        fetchDormData();
    </script>

        // Function to create a dorm card
        function createDormCard(dorm) {
            const sexClass = dorm.Sex === 'Male' ? 'bg-blue-100 text-blue-700' : dorm.Sex === 'Female' ? 'bg-pink-100 text-pink-700' : 'bg-purple-100 text-purple-700';
            
            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden">
                    <div class="p-6">
                        <span class="${sexClass} inline-block px-3 py-1 rounded-full font-semibold text-sm mb-3">
                            ${dorm.Sex || 'Coed'}
                        </span>
                        <h3 class="text-xl font-bold text-indigo-600 mb-3">${dorm.Name}</h3>
                        
                        <div class="space-y-2 text-sm text-gray-700">
                            <div class="flex justify-between">
                                <span class="font-semibold">Quad:</span>
                                <span>${dorm.Quad}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Capacity:</span>
                                <span>${dorm.Capacity}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Colors:</span>
                                <span>${dorm.Colors}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Mascot:</span>
                                <span>${dorm.Mascot}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">Chapel:</span>
                                <span>${dorm.Chapel}</span>
                            </div>
                            ${dorm.Notes ? `
                            <div class="pt-2 border-t">
                                <span class="font-semibold">Notes:</span>
                                <p class="text-gray-600 mt-1">${dorm.Notes}</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <span class="inline-block bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold">
                                ${dorm.Quad}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fetch data from API
        async function fetchDormData() {
            try {
                console.log('Fetching from API:', API_BASE_URL);
                
                const apiUrl = API_BASE_URL + '?sheet=dorms';
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data received:', data);
                
                // The API returns {dorms: [...]} or just [{...}, {...}]
                allDorms = data.dorms || data || [];
                
                if (!Array.isArray(allDorms)) {
                    allDorms = [];
                }
                
                if (allDorms.length === 0) {
                    showError('No dorm data found. Check that your Google Sheet has data in the "dorms" sheet with headers in row 1.');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                console.log('Successfully loaded', allDorms.length, 'dorms');
                filteredDorms = [...allDorms];
                renderGrid();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('Error fetching dorm data:', error);
                showError(`Failed to load dorm data: ${error.message}. Make sure your Google Apps Script is deployed and the URL is correct.`);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function applyFilters() {
            const sex = document.getElementById('sexFilter').value;
            const quad = document.getElementById('quadFilter').value;
            const capacityMin = parseInt(document.getElementById('capacityMin').value) || 0;
            const capacityMax = parseInt(document.getElementById('capacityMax').value) || Infinity;

            filteredDorms = allDorms.filter(dorm => {
                let capacity = dorm.Capacity;
                if (typeof capacity === 'string') {
                    capacity = parseInt(capacity);
                }
                if (isNaN(capacity)) capacity = 0;

                const sexMatch = !sex || dorm.Sex === sex;
                const quadMatch = !quad || dorm.Quad === quad;
                const capacityMatch = capacity >= capacityMin && capacity <= capacityMax;

                return sexMatch && quadMatch && capacityMatch;
            });

            renderGrid();
        }

        function clearFilters() {
            document.getElementById('sexFilter').value = '';
            document.getElementById('quadFilter').value = '';
            document.getElementById('capacityMin').value = '';
            document.getElementById('capacityMax').value = '';
            filteredDorms = [...allDorms];
            renderGrid();
        }

        function renderGrid() {
            const gridDiv = document.getElementById('grid');
            const emptyMessage = document.getElementById('emptyMessage');
            const resultCount = document.getElementById('resultCount');

            if (filteredDorms.length === 0) {
                gridDiv.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                resultCount.textContent = 'No results';
                return;
            }

            emptyMessage.classList.add('hidden');
            resultCount.textContent = `Showing ${filteredDorms.length} dorm${filteredDorms.length !== 1 ? 's' : ''}`;

            gridDiv.innerHTML = filteredDorms.map(dorm => createDormCard(dorm)).join('');
        }

        // Initialize
        console.log('Page loaded, fetching dorm data...');
        fetchDormData();
    </script>
</body>
</html>
